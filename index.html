<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Controle de Processos - NUP</title>

    <script type="module">
        // Importa√ß√£o via CDN para rodar no GitHub Pages
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
        import { getAuth, signInWithPopup, signOut, GoogleAuthProvider, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-auth.js";
        import { getFirestore, collection, getDocs, addDoc, updateDoc, doc } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";

        // ‚úÖ Configura√ß√£o do Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyBHDwatGIjcMmFXmbdw_kH4dQW-xtZJgcA",
            authDomain: "controle-processo-nup.firebaseapp.com",
            projectId: "controle-processo-nup",
            storageBucket: "controle-processo-nup.appspot.com",
            messagingSenderId: "375467007404",
            appId: "1:375467007404:web:5f3942fcb6d6aa4d26ee09"
        };

        // Inicializa Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const provider = new GoogleAuthProvider();

        // ‚úÖ Define Client ID para evitar erro de "Unauthorized domain"
        provider.setCustomParameters({
            client_id: "375467007404-f89c13rct7unu3sahqqsuebcnah96f2e.apps.googleusercontent.com",
            prompt: "select_account"
        });

        // ‚úÖ Fun√ß√£o de Login com Google
        async function login() {
            try {
                const result = await signInWithPopup(auth, provider);
                console.log("Usu√°rio autenticado:", result.user);
            } catch (error) {
                console.error("Erro ao autenticar:", error);
                alert("Erro ao autenticar: " + error.message);
            }
        }

        // ‚úÖ Fun√ß√£o de Logout
        async function logout() {
            try {
                await signOut(auth);
                console.log("Usu√°rio deslogado");
                window.location.reload();
            } catch (error) {
                console.error("Erro ao sair:", error);
            }
        }

        // ‚úÖ Fun√ß√£o para carregar processos do Firestore
        async function carregarDadosFirestore() {
            const user = auth.currentUser;
            if (!user) {
                alert("Voc√™ precisa estar autenticado para acessar os processos.");
                return;
            }

            try {
                const processosRef = collection(db, 'processos');
                const snapshot = await getDocs(processosRef);
                const dados = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

                preencherTabela(dados);
            } catch (erro) {
                console.error("Erro ao carregar dados:", erro);
                alert("Erro ao carregar dados: " + erro.message);
            }
        }

        // ‚úÖ Fun√ß√£o para adicionar um novo processo
        async function adicionarProcesso() {
            const numero = prompt("N√∫mero do Processo:");
            const data = prompt("Data de Entrada:");
            const assunto = prompt("Assunto:");
            const andamento = prompt("Andamento:");
            const link = prompt("Link:");
            const prazo = prompt("Prazo:");

            if (numero && data && assunto && andamento && link && prazo) {
                await addDoc(collection(db, "processos"), {
                    numero, data, assunto, andamento, link, prazo
                });
                alert("Processo adicionado com sucesso!");
                carregarDadosFirestore();
            } else {
                alert("Todos os campos s√£o obrigat√≥rios!");
            }
        }

        // ‚úÖ Fun√ß√£o para editar um processo
        async function editarProcesso(id) {
            const novoAndamento = prompt("Atualize o andamento do processo:");
            if (novoAndamento) {
                const processoRef = doc(db, "processos", id);
                await updateDoc(processoRef, { andamento: novoAndamento });
                alert("Processo atualizado com sucesso!");
                carregarDadosFirestore();
            }
        }

        // ‚úÖ Atualiza interface ao mudar estado de autentica√ß√£o
        onAuthStateChanged(auth, (user) => {
            const loginScreen = document.getElementById("loginScreen");
            const appScreen = document.getElementById("appScreen");

            if (user) {
                loginScreen.style.display = "none";
                appScreen.style.display = "block";
                document.getElementById("status").innerText = `Logado como: ${user.displayName}`;
                carregarDadosFirestore();
            } else {
                loginScreen.style.display = "block";
                appScreen.style.display = "none";
            }
        });

        // ‚úÖ Fun√ß√£o para preencher a tabela com os dados do Firestore
        function preencherTabela(dados) {
            const tabela = document.getElementById("tabelaProcessos").querySelector("tbody");
            tabela.innerHTML = "";

            dados.forEach(d => {
                const linha = `<tr>
                    <td>${d.numero}</td>
                    <td>${d.data}</td>
                    <td>${d.assunto}</td>
                    <td>${d.andamento}</td>
                    <td><a href="${d.link}" target="_blank">Abrir</a></td>
                    <td>${d.prazo}</td>
                    <td><button onclick="editarProcesso('${d.id}')">‚úèÔ∏è Editar</button></td>
                </tr>`;
                tabela.insertAdjacentHTML('beforeend', linha);
            });
        }

        // Disponibilizar fun√ß√µes globalmente
        window.login = login;
        window.logout = logout;
        window.carregarDadosFirestore = carregarDadosFirestore;
        window.adicionarProcesso = adicionarProcesso;
        window.editarProcesso = editarProcesso;
    </script>

    <style>
        body { font-family: Arial, sans-serif; text-align: center; }
        button { padding: 10px; margin: 5px; cursor: pointer; background: #4CAF50; color: white; border: none; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { border: 1px solid black; padding: 8px; }
        th { background-color: #4CAF50; color: white; }
    </style>
</head>
<body>

    <!-- ‚úÖ Tela de Login -->
    <div id="loginScreen">
        <h2>Fa√ßa login para acessar o sistema</h2>
        <button onclick="login()">üîë Login com Google</button>
    </div>

    <!-- ‚úÖ Tela do Aplicativo -->
    <div id="appScreen" style="display: none;">
        <h1>Controle de Processos - NUP</h1>
        <div id="status"></div>
        <button onclick="logout()">üö™ Sair</button>
        <button onclick="adicionarProcesso()">‚ûï Adicionar Processo</button>
        <button onclick="carregarDadosFirestore()">üîÑ Recarregar Processos</button>

        <table id="tabelaProcessos">
            <thead>
                <tr>
                    <th>N√∫mero</th>
                    <th>Data Entrada</th>
                    <th>Assunto</th>
                    <th>Andamento</th>
                    <th>Link</th>
                    <th>Prazo</th>
                    <th>A√ß√µes</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>

</body>
</html>
