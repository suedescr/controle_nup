<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Controle de Processos - NUP</title>

    <script type="module">
        try {
            // âœ… ImportaÃ§Ã£o do Firebase
            import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
            import { getAuth, signInWithPopup, signOut, GoogleAuthProvider, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-auth.js";
            import { getFirestore, collection, getDocs, addDoc } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";

            console.log("âœ… Firebase importado com sucesso!");

            // âœ… ConfiguraÃ§Ã£o do Firebase
            const firebaseConfig = {
                apiKey: "AIzaSyBHDwatGIjcMmFXmbdw_kH4dQW-xtZJgcA",
                authDomain: "controle-processo-nup.firebaseapp.com",
                projectId: "controle-processo-nup",
                storageBucket: "controle-processo-nup.appspot.com",
                messagingSenderId: "375467007404",
                appId: "1:375467007404:web:5f3942fcb6d6aa4d26ee09"
            };

            // âœ… Inicializa Firebase
            const app = initializeApp(firebaseConfig);
            const auth = getAuth(app);
            const db = getFirestore(app);
            const provider = new GoogleAuthProvider();

            console.log("âœ… Firebase inicializado!");

            provider.setCustomParameters({ prompt: "select_account" });

            // âœ… FunÃ§Ã£o de Login com Google
            async function loginGoogle() {
                try {
                    await signInWithPopup(auth, provider);
                    console.log("UsuÃ¡rio autenticado com Google!");
                } catch (error) {
                    alert("Erro ao autenticar com Google: " + error.message);
                }
            }

            // âœ… FunÃ§Ã£o de Login com E-mail e Senha
            async function loginEmailSenha() {
                const email = document.getElementById("email").value;
                const senha = document.getElementById("senha").value;
                try {
                    await signInWithEmailAndPassword(auth, email, senha);
                    console.log("UsuÃ¡rio autenticado com e-mail e senha!");
                } catch (error) {
                    alert("Erro ao autenticar: " + error.message);
                }
            }

            // âœ… FunÃ§Ã£o para Criar Conta com E-mail e Senha
            async function registrar() {
                const email = document.getElementById("email").value;
                const senha = document.getElementById("senha").value;

                if (senha.length < 6) {
                    alert("A senha deve ter pelo menos 6 caracteres.");
                    return;
                }

                try {
                    await createUserWithEmailAndPassword(auth, email, senha);
                    alert("Conta criada com sucesso! Agora faÃ§a login.");
                } catch (error) {
                    alert("Erro ao criar conta: " + error.message);
                }
            }

            // âœ… FunÃ§Ã£o de Logout
            async function logout() {
                try {
                    await signOut(auth);
                    console.log("UsuÃ¡rio deslogado!");
                    window.location.reload();
                } catch (error) {
                    console.error("Erro ao sair:", error);
                }
            }

            // âœ… Atualiza interface ao mudar estado de autenticaÃ§Ã£o
            onAuthStateChanged(auth, (user) => {
                const loginScreen = document.getElementById("loginScreen");
                const appScreen = document.getElementById("appScreen");

                if (user) {
                    loginScreen.style.display = "none";
                    appScreen.style.display = "block";
                    document.getElementById("status").innerText = `Logado como: ${user.email || user.displayName}`;
                    carregarDadosFirestore();
                } else {
                    loginScreen.style.display = "block";
                    appScreen.style.display = "none";
                }
            });

            // âœ… FunÃ§Ã£o para carregar os processos do Firestore
            async function carregarDadosFirestore() {
                try {
                    const processosRef = collection(db, 'processos');
                    const snapshot = await getDocs(processosRef);
                    const dados = snapshot.docs.map(doc => doc.data());

                    console.log("ðŸ“„ Dados carregados:", dados);

                    if (dados.length === 0) {
                        alert("Nenhum processo encontrado.");
                    } else {
                        preencherTabela(dados);
                    }
                } catch (erro) {
                    console.error("Erro ao carregar processos:", erro);
                    alert("Erro ao carregar processos: " + erro.message);
                }
            }

            // âœ… FunÃ§Ã£o para cadastrar um novo processo no Firestore
            async function cadastrarProcesso() {
                const numero = document.getElementById("numero").value;
                const data = document.getElementById("data").value;
                const assunto = document.getElementById("assunto").value;
                const andamento = document.getElementById("andamento").value;
                const link = document.getElementById("link").value;
                const prazo = document.getElementById("prazo").value;

                try {
                    await addDoc(collection(db, "processos"), {
                        numero,
                        data,
                        assunto,
                        andamento,
                        link,
                        prazo
                    });
                    alert("Processo cadastrado com sucesso!");
                    carregarDadosFirestore(); // Atualiza a tabela
                } catch (erro) {
                    console.error("Erro ao cadastrar processo:", erro);
                    alert("Erro ao cadastrar processo: " + erro.message);
                }
            }

            // âœ… FunÃ§Ã£o para preencher a tabela
            function preencherTabela(dados) {
                const tabela = document.getElementById("tabelaProcessos").querySelector("tbody");
                tabela.innerHTML = "";

                dados.forEach(d => {
                    const linha = `<tr>
                        <td>${d.numero || 'N/A'}</td>
                        <td>${d.data || 'N/A'}</td>
                        <td>${d.assunto || 'N/A'}</td>
                        <td>${d.andamento || 'N/A'}</td>
                        <td><a href="${d.link}" target="_blank">Abrir</a></td>
                        <td>${d.prazo || 'N/A'}</td>
                    </tr>`;
                    tabela.insertAdjacentHTML('beforeend', linha);
                });
            }

            window.loginGoogle = loginGoogle;
            window.loginEmailSenha = loginEmailSenha;
            window.registrar = registrar;
            window.logout = logout;
            window.cadastrarProcesso = cadastrarProcesso;

        } catch (erro) {
            console.error("Erro geral no script:", erro);
            alert("Ocorreu um erro ao carregar a pÃ¡gina. Verifique o console para mais detalhes.");
        }
    </script>

    <style>
        body { font-family: Arial, sans-serif; text-align: center; }
        button { padding: 10px; margin: 5px; cursor: pointer; background: #4CAF50; color: white; border: none; }
        input { padding: 8px; margin: 5px; width: 250px; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { border: 1px solid black; padding: 8px; }
        th { background-color: #4CAF50; color: white; }
    </style>
</head>
<body>
    <h1>Se aparecer erro, abra o console (F12) e veja os detalhes!</h1>
</body>
</html>
